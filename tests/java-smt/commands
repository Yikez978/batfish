#this file assumes that we are running from top-level source directory

add-batfish-option haltonconverterror
add-batfish-option haltonparseerror
add-batfish-option verboseparse

# all tests with BGP only
test tests/java-smt/bgp1-init.ref init-testrig test_rigs/smt-examples/BGP1
test tests/java-smt/bgp1-forwarding.ref get smt-forwarding dstIps=["42.42.42.0"]
test tests/java-smt/bgp1-reachability.ref get smt-reachability finalNodeRegex="R1" | finalIfaceRegex="Loopback.*"
test tests/java-smt/bgp1-bounded-len.ref get smt-bounded-length finalNodeRegex="R1" | finalIfaceRegex="Loopback.*" | bound=1
test tests/java-smt/bgp1-bounded-len2.ref get smt-bounded-length finalNodeRegex="R1" | finalIfaceRegex="Loopback.*" | bound=0
test tests/java-smt/bgp1-routing-loop.ref get smt-routing-loop
test tests/java-smt/bgp1-blackhole.ref get smt-blackhole
test tests/java-smt/bgp1-multipath.ref get smt-multipath-consistency finalNodeRegex="R1" | finalIfaceRegex="Loopback.*"

# all tests with ospf only
test tests/java-smt/ospf3-init.ref init-testrig test_rigs/smt-examples/OSPF3
test tests/java-smt/ospf3-forward.ref get smt-forwarding dstIps=["70.70.70.70"]
test tests/java-smt/ospf3-reachable.ref get smt-reachability finalNodeRegex="R3" | finalIfaceRegex="Loopback.*"
test tests/java-smt/ospf3-bounded-len.ref get smt-bounded-length finalNodeRegex="R3" | finalIfaceRegex="Loopback.*" | bound=2
test tests/java-smt/ospf3-bounded-len2.ref get smt-bounded-length finalNodeRegex="R3" | finalIfaceRegex="Loopback.*" | bound=1
test tests/java-smt/ospf3-equal-len.ref get smt-equal-length finalNodeRegex="R3" | finalIfaceRegex="Loopback.*" | ingressNodeRegex="R(1|2)"
test tests/java-smt/ospf3-equal-len2.ref get smt-equal-length finalNodeRegex="R3" | finalIfaceRegex="Loopback.*" | ingressNodeRegex="R(1|0)"
test tests/java-smt/ospf3-routing-loop.ref get smt-routing-loop
test tests/java-smt/ospf3-blackhole.ref get smt-blackhole
test tests/java-smt/ospf3-multipath.ref get smt-multipath-consistency finalNodeRegex="R3" | finalIfaceRegex="Loopback.*"

# local consistency with bgp + environment
test tests/java-smt/env2-init.ref init-testrig test_rigs/smt-examples/ENV2
test tests/java-smt/env2-local.ref get smt-local-consistency nodeRegex=".*"
test tests/java-smt/env2-local2.ref get smt-local-consistency nodeRegex=""

# forwarding loop with static routes
test tests/java-smt/static2-init.ref init-testrig test_rigs/smt-examples/STATIC2
test tests/java-smt/static2-forward.ref get smt-forwarding dstIps=["172.0.0.0"]
test tests/java-smt/static2-loop.ref get smt-routing-loop

# redistribution of different protocols
test tests/java-smt/redistribute1-init.ref init-testrig test_rigs/smt-examples/REDISTRIBUTE1
test tests/java-smt/redistribute1-forwarding1.ref get smt-forwarding dstIps=["70.70.70.70"]
test tests/java-smt/redistribute1-forwarding2.ref get smt-forwarding dstIps=["69.69.69.0"]
test tests/java-smt/redistribute1-forwarding3.ref get smt-forwarding dstIps=["180.0.0.0"]
test tests/java-smt/redistribute1-forwarding4.ref get smt-forwarding dstIps=["140.0.0.0"]

# Ensure correct handling of inactive links in OSPF
test tests/java-smt/ospf1-init.ref init-testrig test_rigs/smt-examples/OSPF1
test tests/java-smt/ospf1-forwarding.ref get smt-forwarding dstIps=["70.70.70.70"]

# Only propagate routes when they are in the FIB
test tests/java-smt/ospf2-init.ref init-testrig test_rigs/smt-examples/OSPF2
test tests/java-smt/ospf2-forwarding.ref get smt-forwarding dstIps=["70.70.70.70"]
test tests/java-smt/ospf4-init.ref init-testrig test_rigs/smt-examples/OSPF4
test tests/java-smt/ospf4-forwarding.ref get smt-forwarding dstIps=["70.70.70.70"]

# Ensure prepending updates path
test tests/java-smt/prepend1-init.ref init-testrig test_rigs/smt-examples/PREPEND1
test tests/java-smt/prepend1-forwarding.ref get smt-forwarding dstIps=["41.41.41.1"]

# Check proper dropping behavior when the metric has overflow
test tests/java-smt/overflow1-init.ref init-testrig test_rigs/smt-examples/OVERFLOW1
test tests/java-smt/overflow1-forwarding.ref get smt-forwarding dstIps=["41.41.41.1"]